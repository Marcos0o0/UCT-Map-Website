---
// Componente MapaInteractivo.astro
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

<!-- Componente Mapa -->
<div class="max-w-7xl mx-auto pt-44">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Panel Lateral -->
        <div class="lg:col-span-1 space-y-4">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">Filtros</h3>
                <div class="space-y-2">
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="edificio" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Edificios Académicos</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="libreria" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Bibliotecas</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="comer" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Cafeterías</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="baños" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Baños</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="estacionamiento" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Estacionamientos</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="bicicletas" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Est. Bicicletas</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="gym" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Gimnasio</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="calistenia" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Calistenia</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="impresion" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Impresiones</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="daas" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">DAAS</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" class="marker-filter" data-type="tesoreria" checked>
                        <span class="checkmark"></span>
                        <span class="label-text">Tesorería</span>
                    </label>
                </div>

                <div class="flex gap-2 mt-4">
                    <button id="select-all" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition font-medium">
                        Todos
                    </button>
                    <button id="deselect-all" class="flex-1 px-3 py-2 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600 transition font-medium">
                        Ninguno
                    </button>
                </div>
            </div>
        </div>

        <!-- Mapa Principal -->
        <div class="lg:col-span-3">
            <div id="map-wrapper" class="rounded-xl shadow-lg overflow-visible relative">
                <div class="absolute top-4 right-4 flex gap-2 z-[500]" style="transform: translateX(-8px);">
                    <button id="zoom-in" class="bg-white p-2 rounded-lg shadow hover:shadow-md transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    <button id="zoom-out" class="bg-white p-2 rounded-lg shadow hover:shadow-md transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                        </svg>
                    </button>
                    <button id="fullscreen-btn" class="bg-white p-2 rounded-lg shadow hover:shadow-md transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="enhanced-map" class="w-full rounded-xl" style="height: 600px;"></div>
                
                <button id="exit-fullscreen" class="hidden absolute top-4 right-4 z-[1000] px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Salir
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let map;
    let bounds;
    let width = 0;
    let height = 0;

    // Configurar iconos por defecto
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
        iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png'
    });

    // Crear iconos personalizados
    const createMarkerWithSVG = (iconPath, color) => L.divIcon({
        html: `
            <svg width="35" height="45" viewBox="0 0 24 24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="${color}"/>
                <image href="${iconPath}" x="7" y="5" height="10" width="10"/>
            </svg>
        `,
        className: '',
        iconSize: [75, 90],
        iconAnchor: [17, 45],
        popupAnchor: [0, -45]
    });

    const customIcons = {
        edificio: createMarkerWithSVG('../markers/building.svg', '#3B82F6'),
        libreria: createMarkerWithSVG('/markers/library.svg', '#10B981'),
        laboratorio: createMarkerWithSVG('/markers/lab.svg', '#F59E0B'),
        comer: createMarkerWithSVG('/markers/utensils.svg', '#EF4444'),
        estacionamiento: createMarkerWithSVG('/markers/parking.svg', '#6366F1'),
        baños: createMarkerWithSVG('/markers/toilet.svg', '#6B7280'),
        bicicletas: createMarkerWithSVG('/markers/bike.svg', '#F97316'),
        gym: createMarkerWithSVG('/markers/dumbbell.svg', '#8B5CF6'),
        calistenia: createMarkerWithSVG('/markers/biceps-flexed.svg', '#EC4899'),
        impresion: createMarkerWithSVG('/markers/printer.svg', '#14B8A6'),
        daas: createMarkerWithSVG('/markers/notebook-pen.svg', '#F43F5E'),
        tesoreria: createMarkerWithSVG('/markers/wallet.svg', '#22C55E')
    };

    // Crear imagen para obtener dimensiones
    const img = new Image();
    
    img.onload = function() {
        width = this.naturalWidth;
        height = this.naturalHeight;
        
        map = L.map('enhanced-map', {
            crs: L.CRS.Simple,
            maxBoundsViscosity: 1.0,
            minZoom: -1,
            maxZoom: 0.5,
            zoomControl: false,
            tap: true,
            touchZoom: true,
            doubleClickZoom: true,
            scrollWheelZoom: true,
            boxZoom: true,
            keyboard: true,
            dragging: true,
            attributionControl: false
        });

        bounds = [[0, 0], [height, width]];
        
        L.imageOverlay('/Map.png', bounds).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds(bounds);
        map.setView([height / 2, width / 2], -1);

        // Marcadores
        const predefinedMarkers = [
            { pos: [height * 0.277, width * 0.323], name: "Edificio 1", type: "edificio", description: "Edificio de informaciones y asistentes sociales" },
            { pos: [height * 0.394, width * 0.407], name: "Edificio 2", type: "edificio", description: "Edificio con salas de clase, baños y sala de estar" },
            { pos: [height * 0.443, width * 0.549], name: "Edificio 3", type: "edificio", description: "Edificio con salas de clase, baños y sala de estar" },
            { pos: [height * 0.504, width * 0.487], name: "Biblioteca", type: "libreria", description: "Venta de libros y sala de estudio" },
            { pos: [height * 0.533, width * 0.667], name: "Servicio de impresiones", type: "impresion", description: "Libreria con servicio de impresiones" },
            { pos: [height * 0.59, width * 0.705], name: "DAAS", type: "daas", description: "Dirección de Acompañamiento Académico y Socioemocional" },
            { pos: [height * 0.77, width * 0.88], name: "Tesoreria", type: "tesoreria", description: "Gestión de pagos y trámites financieros" },
            { pos: [height * 0.92, width * 0.575], name: "Edificio 12", type: "edificio", description: "Edificio con salas de clase, baños y sala de estar" },
            { pos: [height * 0.842, width * 0.515], name: "Edificio 13", type: "edificio", description: "Edificio con salas de clase, baños y sala de estar" },
            { pos: [height * 0.767, width * 0.45], name: "Edificio 14", type: "edificio", description: "Edificio con salas de clase, baños y sala de estar" },
            { pos: [height * 0.654, width * 0.376], name: "Edificio 15", type: "edificio", description: "Edificio con salas de clase, baños y sala de estar" },
            { pos: [height * 0.497, width * 0.255], name: "Edificio 16", type: "edificio", description: "Edificio de carreras técnicas" },
            { pos: [height * 0.418, width * 0.233], name: "Edificio 17", type: "edificio", description: "Edificio con apartado de informática y enfermería" },
            { pos: [height * 0.36, width * 0.597], name: "Edificio 21", type: "edificio", description: "Edificio con salas de clase, baños y sala de estar" },
            { pos: [height * 0.35, width * 0.47], name: "Biblioteca Central", type: "libreria", description: "Recursos académicos y salas de estudio" },
            { pos: [height * 0.49, width * 0.64], name: "Cafetería", type: "comer", description: "Cafetería para todo público" },
            { pos: [height * 0.79, width * 0.67], name: "Comedor", type: "comer", description: "Comedor piso 1" },
            { pos: [height * 0.757, width * 0.81], name: "Estacionamiento", type: "estacionamiento", description: "Zona de estacionamiento para todo público" },
            { pos: [height * 0.8, width * 0.77], name: "Baños Públicos", type: "baños", description: "Baños para todo público" },
            { pos: [height * 0.42, width * 0.181], name: "Estacionamiento de Bicicletas", type: "bicicletas", description: "Zona segura para estacionar bicicletas" },
            { pos: [height * 0.63, width * 0.395], name: "Gimnasio", type: "gym", description: "Gimnasio en edificio 15" },
            { pos: [height * 0.56, width * 0.64], name: "Zona de Calistenia", type: "calistenia", description: "Área al aire libre para ejercicios" }
        ];

        const markersByType = {};

        predefinedMarkers.forEach(marker => {
            const icon = customIcons[marker.type];
            if (!icon) return;
            
            const leafletMarker = L.marker(marker.pos, { icon })
                .addTo(map)
                .bindPopup(
                    `<div class="p-2">
                        <h3 class="font-bold text-lg mb-2">${marker.name}</h3>
                        <p class="text-sm text-gray-600 mb-2">${marker.description}</p>
                    </div>`,
                    {
                        autoPan: true,
                        autoPanPadding: [10, 10],
                        keepInView: true,
                    }
                );

            if (!markersByType[marker.type]) {
                markersByType[marker.type] = [];
            }
            markersByType[marker.type].push(leafletMarker);
        });

        // Función para actualizar marcadores
        function updateMarkers() {
            document.querySelectorAll('.marker-filter').forEach(cb => {
                const type = cb.dataset.type;
                const show = cb.checked;

                markersByType[type]?.forEach(marker => {
                    if (show) {
                        marker.addTo(map);
                    } else {
                        map.removeLayer(marker);
                    }
                });
            });
        }

        // Event listeners para filtros
        document.querySelectorAll('.marker-filter').forEach(cb => {
            cb.addEventListener('change', updateMarkers);
        });

        // Botones Todos/Ninguno
        document.getElementById('select-all').addEventListener('click', () => {
            document.querySelectorAll('.marker-filter').forEach(cb => cb.checked = true);
            updateMarkers();
        });
        
        document.getElementById('deselect-all').addEventListener('click', () => {
            document.querySelectorAll('.marker-filter').forEach(cb => cb.checked = false);
            updateMarkers();
        });

        // Controles de zoom personalizados
        document.getElementById('zoom-in').addEventListener('click', () => {
            map.zoomIn();
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            map.zoomOut();
        });
    };

    img.src = '/Map.png';

    // Pantalla completa
    document.getElementById('fullscreen-btn').addEventListener('click', function() {
        const mapWrapper = document.getElementById('map-wrapper');
        const exitBtn = document.getElementById('exit-fullscreen');
        const mapDiv = document.getElementById('enhanced-map');
        const customControls = document.querySelectorAll('#zoom-in, #zoom-out, #fullscreen-btn');
        
        if (!document.fullscreenElement) {
            mapWrapper.requestFullscreen().then(() => {
                mapDiv.style.width = '100vw';
                mapDiv.style.height = '100vh';
                customControls.forEach(btn => btn.style.display = 'none');
                setTimeout(() => {
                    map.invalidateSize();
                    map.fitBounds(bounds);
                }, 300);
                exitBtn.classList.remove('hidden');
            });
        }
    });

    document.getElementById('exit-fullscreen').addEventListener('click', function() {
        document.exitFullscreen();
    });

    document.addEventListener('fullscreenchange', function() {
        const mapDiv = document.getElementById('enhanced-map');
        const exitBtn = document.getElementById('exit-fullscreen');
        const customControls = document.querySelectorAll('#zoom-in, #zoom-out, #fullscreen-btn');
        
        if (!document.fullscreenElement) {
            mapDiv.style.width = '100%';
            mapDiv.style.height = '600px';
            customControls.forEach(btn => btn.style.display = 'flex');
            exitBtn.classList.add('hidden');
            setTimeout(() => {
                map.invalidateSize();
                map.fitBounds(bounds);
            }, 300);
        }
    });

    window.addEventListener('resize', function() {
        if (map) {
            setTimeout(() => map.invalidateSize(), 100);
        }
    });
});
</script>

<style>
    /* Checkboxes personalizados */
    .custom-checkbox {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        padding: 6px 8px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }

    .custom-checkbox:hover {
        background-color: #f3f4f6;
    }

    .custom-checkbox input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }

    .checkmark {
        position: relative;
        height: 20px;
        width: 20px;
        background-color: #fff;
        border: 2px solid #d1d5db;
        border-radius: 6px;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .custom-checkbox:hover .checkmark {
        border-color: #3b82f6;
    }

    .custom-checkbox input:checked ~ .checkmark {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
        left: 6px;
        top: 2px;
        width: 4px;
        height: 9px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .custom-checkbox input:checked ~ .checkmark:after {
        display: block;
    }

    .label-text {
        margin-left: 10px;
        color: #374151;
        font-size: 14px;
    }

    /* Remover bordes blancos del mapa */
    .leaflet-control-attribution {
        display: none !important;
    }

    .leaflet-popup-content-wrapper {
        border-radius: 12px;
    }

    .leaflet-container {
        background: transparent !important;
    }

    #enhanced-map {
        background: transparent !important;
    }

    #map-wrapper {
        background: transparent !important;
    }

    .leaflet-pane {
        background: transparent !important;
    }

    .leaflet-tile-pane {
        background: transparent !important;
    }

    .leaflet-overlay-pane {
        background: transparent !important;
    }

    #map-wrapper:fullscreen {
        background: #000;
    }

    #map-wrapper:fullscreen #enhanced-map {
        width: 100vw !important;
        height: 100vh !important;
        border-radius: 0;
    }

    @media (max-width: 768px) {
        #enhanced-map {
            height: 500px !important;
        }
    }
</style>
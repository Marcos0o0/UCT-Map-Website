---
// TourSection.astro - Con menú lateral funcional en fullscreen
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>

<div class="relative overflow-visible">
  <div class="relative max-w-7xl mx-auto px-4 lg:px-6">
    <!-- Título de la sección -->
    <div class="text-center mb-8 lg:mb-12 animate-[slideDown_0.6s_ease-out_0.1s_both]">
      <h2 class="text-3xl lg:text-5xl font-black mb-4 gradient-text animation-gradient">
        Tour Virtual 360°
      </h2>
      <p class="text-lg lg:text-xl text-gray-600 max-w-2xl mx-auto font-medium leading-relaxed">
        Recorre el Campus San Francisco desde cualquier lugar
      </p>
    </div>

    <!-- Visor panorámico -->
    <div class="rounded-3xl shadow-2xl overflow-hidden relative bg-black animate-[slideDown_0.6s_ease-out_0.2s_both]">
      <!-- Controles superiores (se mantienen en fullscreen) -->
      <div id="top-controls" class="absolute top-3 left-10 lg:left-12 flex gap-1.5 z-[9999]">
        <button id="prev-scene" class="bg-white/95 backdrop-blur-sm px-2.5 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105 flex items-center gap-1.5 font-semibold text-gray-700 hover:bg-white border border-gray-200">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          <span class="hidden sm:inline text-xs">Anterior</span>
        </button>
        <button id="next-scene" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-2.5 py-2 rounded-xl font-semibold flex items-center gap-1.5 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
          <span class="hidden sm:inline text-xs">Siguiente</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
        
        <!-- Botón para abrir menú lateral -->
        <button id="toggle-menu" class="bg-white/95 backdrop-blur-sm px-2.5 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105 font-semibold text-gray-700 hover:bg-white border border-gray-200">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>

      <!-- Info de escena actual (se mantiene en fullscreen) -->
      <div id="scene-info" class="absolute top-3 right-3 lg:right-4 z-[9999]">
        <div class="bg-white/95 backdrop-blur-sm px-3.5 py-2 rounded-xl shadow-lg border border-gray-200">
          <p id="scene-title" class="font-semibold text-xs lg:text-sm text-gray-800">Entrada principal</p>
        </div>
      </div>

      <!-- Menú lateral de escenas (se mantiene en fullscreen) -->
      <div id="hotspots-menu" class="hidden absolute left-4 top-24 z-[9999] bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200 overflow-hidden max-w-xs">
        <div class="p-4 bg-gradient-to-r from-blue-500 to-blue-600">
          <h3 class="text-white font-bold text-lg">Escenas del Tour</h3>
        </div>
        <div class="max-h-[500px] overflow-y-auto p-2">
            <!-- RECORRIDO EXTERIOR -->
            <div class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wide">Recorrido Exterior</div>
            <button class="hotspot-item" data-scene="entrada">Entrada Principal</button>

            <!-- EDIFICIOS -->
            <div class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wide mt-2">Edificios</div>
            <button class="hotspot-item" data-scene="informaciones">Informaciones</button>
            <button class="hotspot-item" data-scene="pasillo_edf_21">Pasillo Edificio 21</button>
            <button class="hotspot-item" data-scene="inters_edf_15_16">Edificios 15-16</button>

            <!-- AULAS Y ESPACIOS ACADÉMICOS -->
            <div class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wide mt-2">Espacios Académicos</div>
            <button class="hotspot-item" data-scene="aula_magna_01">Aula Magna</button>
            <button class="hotspot-item" data-scene="sala_clases_01">Salas de Clases</button>
            <button class="hotspot-item" data-scene="computacion">Sala de Computación</button>

            <!-- BIBLIOTECA -->
            <div class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wide mt-2">Biblioteca</div>
            <button class="hotspot-item" data-scene="biblioteca">Biblioteca Central</button>
            <button class="hotspot-item" data-scene="ent_biblio_01">Entrada Biblioteca</button>

            <!-- SERVICIOS -->
            <div class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wide mt-2">Servicios</div>
            <button class="hotspot-item" data-scene="comedor_01">Comedor</button>
            <button class="hotspot-item" data-scene="estacionamiento">Estacionamiento</button>

            <!-- ÁREAS RECREATIVAS -->
            <div class="px-3 py-2 text-xs font-bold text-gray-500 uppercase tracking-wide mt-2">Áreas Recreativas</div>
            <button class="hotspot-item" data-scene="calistenia">Zona de Calistenia</button>
            <button class="hotspot-item" data-scene="areas_verdes">Áreas Verdes</button>
        </div>
      </div>

      <!-- Visor Pannellum -->
      <div id="panorama" data-lenis-prevent class="w-full h-[700px] sm:h-[500px] lg:h-[700px]" style="min-height: 700px;"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sceneOrder = ['entrada', 'ext_02', 'ext_03', 'ext_04', 'ext_05', 'ext_06', 'ext_07', 'ext_08', 'ext_09'];
    const sceneTitles = {
        'entrada': 'Entrada principal',
        'ext_02': 'Exterior 02',
        'ext_03': 'Exterior 03',
        'ext_04': 'Exterior 04',
        'ext_05': 'Exterior 05',
        'ext_06': 'Exterior 06',
        'ext_07': 'Exterior 07',
        'ext_08': 'Exterior 08',
        'ext_09': 'Exterior 09',
        'biblioteca': 'Biblioteca Central',
        'aula_magna_01': 'Aula Magna - Vista 1',
        'aula_magna_02': 'Aula Magna - Vista 2',
        'calistenia': 'Zona de Calistenia',
        'comedor_01': 'Comedor - Vista 1',
        'comedor_02': 'Comedor - Vista 2',
        'computacion': 'Sala de Computación',
        'ent_aula_magna': 'Entrada Aula Magna',
        'ent_biblio_01': 'Entrada Biblioteca 1',
        'ent_biblio_02': 'Entrada Biblioteca 2',
        'ent_biblio_03': 'Entrada Biblioteca 3',
        'estacionamiento': 'Estacionamiento',
        'pasillo_edf_21': 'Pasillo Edificio 21',
        'informaciones': 'Informaciones',
        'inters_edf_15_16': 'Intersección Edificio 15-16',
        'sala_clases_01': 'Sala de Clases 1',
        'sala_clases_02': 'Sala de Clases 2',
        'sala_clases_03': 'Sala de Clases 3',
        'areas_verdes': 'Áreas Verdes'
    };

    let currentSceneIndex = 0;

    const viewer = pannellum.viewer('panorama', {
        default: {
            firstScene: 'entrada',
            sceneFadeDuration: 1000,
            preview: "./load_img_uct.webp",
            strings: {
                loadButtonLabel: "Haz click aquí para cargar el tour"
            }
        },
        scenes: {
            entrada: {
                type: "equirectangular",
                panorama: "./360_img/Ext_01.jpg",
                pitch: 0,
                yaw: 0,
                minHfov: 80,
                maxHfov: 120,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -10,
                        yaw: -3,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_02"
                    }
                ]
            },
            ext_02: {
                type: "equirectangular",
                panorama: "./360_img/Ext_02.jpg",
                pitch: 0,
                yaw: 180,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -2,
                        yaw: 170,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_03"
                    }
                ]
            },
            ext_03: {
                type: "equirectangular",
                panorama: "./360_img/Ext_03.jpg",
                pitch: 0,
                yaw: 0,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -7,
                        yaw: -10,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_04"
                    }
                ]
            },
            ext_04: {
                type: "equirectangular",
                panorama: "./360_img/Ext_04.jpg",
                pitch: 0,
                yaw: 0,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -5,
                        yaw: -5,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_05"
                    },
                    {
                        pitch: -5,
                        yaw: 80,
                        type: "scene",
                        text: "Aula Magna",
                        sceneId: "ent_aula_magna"
                    }
                ]
            },
            ext_05: {
                type: "equirectangular",
                panorama: "./360_img/Ext_05.jpg",
                pitch: 0,
                yaw: 0,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -5,
                        yaw: -5,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_06"
                    }
                ]
            },
            ext_06: {
                type: "equirectangular",
                panorama: "./360_img/Ext_06.jpg",
                pitch: 0,
                yaw: 0,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -4,
                        yaw: -9,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_07"
                    }
                ]
            },
            ext_07: {
                type: "equirectangular",
                panorama: "./360_img/Ext_07.jpg",
                pitch: 0,
                yaw: 0,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -5,
                        yaw: -5,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_08"
                    }
                ]
            },
            ext_08: {
                type: "equirectangular",
                panorama: "./360_img/Ext_08.jpg",
                pitch: 0,
                yaw: 0,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -5,
                        yaw: -5,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "ext_09"
                    }
                ]
            },
            ext_09: {
                type: "equirectangular",
                panorama: "./360_img/Ext_09.jpg",
                pitch: 0,
                yaw: 180,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: -5,
                        yaw: 185,
                        type: "scene",
                        text: "Avanzar",
                        sceneId: "comedor_01"
                    }
                ]
            },
            comedor_01: {
            type: "equirectangular",
            panorama: "./360_img/Comedor_01.jpg",
            pitch: 0,
            yaw: 0,
            hfov: 120,
            hotSpots: [
                {
                    pitch: 0,
                    yaw: -90,
                    type: "scene",
                    text: "Ver otra zona",
                    sceneId: "comedor_02"
                }
            ]
            },
            comedor_02: {
                type: "equirectangular",
                panorama: "./360_img/Comedor_02.jpg",
                pitch: 0,
                yaw: 0,
                hfov: 120,
                hotSpots: [
                    {
                        pitch: 0,
                        yaw: 90,
                        type: "scene",
                        text: "Vista anterior",
                        sceneId: "comedor_01"
                    }
                ]
            },
            biblioteca: {
    type: "equirectangular",
    panorama: "./360_img/Biblioteca.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
},
aula_magna_01: {
    type: "equirectangular",
    panorama: "./360_img/Aula_Magna_01.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: 90,
            type: "scene",
            text: "Ver otra vista",
            sceneId: "aula_magna_02"
        }
    ]
},
aula_magna_02: {
    type: "equirectangular",
    panorama: "./360_img/Aula_Magna_02.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: -90,
            type: "scene",
            text: "Vista anterior",
            sceneId: "aula_magna_01"
        }
    ]
},
calistenia: {
    type: "equirectangular",
    panorama: "./360_img/Calistenia.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
},

computacion: {
    type: "equirectangular",
    panorama: "./360_img/Computacion.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
},
ent_aula_magna: {
    type: "equirectangular",
    panorama: "./360_img/Ent_Aula_Magna.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: 0,
            type: "scene",
            text: "Entrar al Aula Magna",
            sceneId: "aula_magna_01"
        }
    ]
},
ent_biblio_01: {
    type: "equirectangular",
    panorama: "./360_img/Ent_Biblio_Comput_01.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: 45,
            type: "scene",
            text: "Siguiente vista",
            sceneId: "ent_biblio_02"
        }
    ]
},
ent_biblio_02: {
    type: "equirectangular",
    panorama: "./360_img/Ent_Biblio_Comput_02.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: -45,
            type: "scene",
            text: "Vista anterior",
            sceneId: "ent_biblio_01"
        },
        {
            pitch: 0,
            yaw: 45,
            type: "scene",
            text: "Siguiente vista",
            sceneId: "ent_biblio_03"
        }
    ]
},
ent_biblio_03: {
    type: "equirectangular",
    panorama: "./360_img/Ent_Biblio_Comput_03.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: -45,
            type: "scene",
            text: "Vista anterior",
            sceneId: "ent_biblio_02"
        },
        {
            pitch: 0,
            yaw: 0,
            type: "scene",
            text: "Entrar a Biblioteca",
            sceneId: "biblioteca"
        }
    ]
},
estacionamiento: {
    type: "equirectangular",
    panorama: "./360_img/Ent_Estacionamiento.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
},
pasillo_edf_21: {
    type: "equirectangular",
    panorama: "./360_img/Ent_Pasillo_Edf_21.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
},
informaciones: {
    type: "equirectangular",
    panorama: "./360_img/Informaciones.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
},
inters_edf_15_16: {
    type: "equirectangular",
    panorama: "./360_img/Inters_Edf_15_16.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
},

sala_clases_01: {
    type: "equirectangular",
    panorama: "./360_img/Sala_Clases_01.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: 90,
            type: "scene",
            text: "Siguiente sala",
            sceneId: "sala_clases_02"
        }
    ]
},
sala_clases_02: {
    type: "equirectangular",
    panorama: "./360_img/Sala_Clases_02.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: -90,
            type: "scene",
            text: "Sala anterior",
            sceneId: "sala_clases_01"
        },
        {
            pitch: 0,
            yaw: 90,
            type: "scene",
            text: "Siguiente sala",
            sceneId: "sala_clases_03"
        }
    ]
},
sala_clases_03: {
    type: "equirectangular",
    panorama: "./360_img/Sala_Clases_03.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: [
        {
            pitch: 0,
            yaw: -90,
            type: "scene",
            text: "Sala anterior",
            sceneId: "sala_clases_02"
        }
    ]
},
areas_verdes: {
    type: "equirectangular",
    panorama: "./360_img/Areas_Verdes.jpg",
    pitch: 0,
    yaw: 0,
    hfov: 120,
    hotSpots: []
}
        }
});

    // Función para mover controles al contenedor de Pannellum en fullscreen
    function moveControlsToFullscreen() {
        const container = document.querySelector('.pnlm-container');
        const topControls = document.getElementById('top-controls');
        const sceneInfo = document.getElementById('scene-info');
        const menu = document.getElementById('hotspots-menu');
        
        if (container && topControls && sceneInfo && menu) {
            container.appendChild(topControls);
            container.appendChild(sceneInfo);
            container.appendChild(menu);
        }
    }

    // Función para restaurar controles a su posición original
    function restoreControlsPosition() {
        const panoramaParent = document.getElementById('panorama').parentElement;
        const topControls = document.getElementById('top-controls');
        const sceneInfo = document.getElementById('scene-info');
        const menu = document.getElementById('hotspots-menu');
        
        if (panoramaParent && topControls && sceneInfo && menu) {
            panoramaParent.insertBefore(topControls, document.getElementById('panorama'));
            panoramaParent.insertBefore(sceneInfo, document.getElementById('panorama'));
            panoramaParent.insertBefore(menu, document.getElementById('panorama'));
        }
    }

    // Detectar cambios de fullscreen
    document.addEventListener('fullscreenchange', function() {
        if (document.fullscreenElement) {
            moveControlsToFullscreen();
        } else {
            restoreControlsPosition();
        }
    });

    // Actualizar título
    function updateSceneInfo(sceneId) {
        currentSceneIndex = sceneOrder.indexOf(sceneId);
        const title = document.getElementById('scene-title');
        if (title) {
            title.textContent = sceneTitles[sceneId];
        }
    }

    // Navegación anterior/siguiente
    document.getElementById('prev-scene').addEventListener('click', () => {
        if (currentSceneIndex > 0) {
            const prevScene = sceneOrder[currentSceneIndex - 1];
            viewer.loadScene(prevScene);
            updateSceneInfo(prevScene);
        }
    });

    document.getElementById('next-scene').addEventListener('click', () => {
        if (currentSceneIndex < sceneOrder.length - 1) {
            const nextScene = sceneOrder[currentSceneIndex + 1];
            viewer.loadScene(nextScene);
            updateSceneInfo(nextScene);
        }
    });

    // Toggle menú de hotspots
    const menuBtn = document.getElementById('toggle-menu');
    const menu = document.getElementById('hotspots-menu');
    let menuOpen = false;

    menuBtn.addEventListener('click', () => {
        menuOpen = !menuOpen;
        if (menuOpen) {
            menu.classList.remove('hidden');
            menu.classList.add('animate-slideInLeft');
        } else {
            menu.classList.add('hidden');
            menu.classList.remove('animate-slideInLeft');
        }
    });

    // Navegación desde el menú
    document.querySelectorAll('.hotspot-item').forEach(button => {
        button.addEventListener('click', () => {
            const sceneId = button.dataset.scene;
            viewer.loadScene(sceneId);
            updateSceneInfo(sceneId);
            // Cerrar menú en móviles
            if (window.innerWidth < 768) {
                menuOpen = false;
                menu.classList.add('hidden');
            }
        });
    });

    // Escuchar cambios de escena de Pannellum
    viewer.on('scenechange', (sceneId) => {
        updateSceneInfo(sceneId);
    });

    // Inicializar info
    updateSceneInfo('entrada');
});
</script>

<style>
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slidePattern {
        from {
            transform: translateX(0);
        }
        to {
            transform: translateX(80px);
        }
    }

    .gradient-text {
        background: linear-gradient(
            to right,
            #1455ff 10%,
            #4e80ff 30%,
            #4784fd 60%,
            #2c71fc 80%  
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-fill-color: transparent;
        background-size: 500% auto;
        animation: textShine 3s ease-in-out infinite alternate;
    }

    @keyframes textShine {
        0% {
            background-position: 0% 50%;
        }
        100% {
            background-position: 100% 50%;
        }
    }

    /* Estilos para el visor */
    #panorama {
        background: #000;
        position: relative;
        width: 100%;
        border-radius: 1rem;
    }

    /* Mejorar controles de Pannellum */
    .pnlm-container {
        border-radius: 1rem;
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
    }

    .pnlm-render-container {
        width: 100% !important;
        height: 100% !important;
        border-radius: 1rem;
    }

    /* Asegurar que los controles se vean en fullscreen */
    #top-controls,
    #scene-info,
    #hotspots-menu {
        position: absolute !important;
    }

    /* En fullscreen, mantener z-index alto */
    .pnlm-container:-webkit-full-screen #top-controls,
    .pnlm-container:-webkit-full-screen #scene-info,
    .pnlm-container:-webkit-full-screen #hotspots-menu,
    .pnlm-container:-moz-full-screen #top-controls,
    .pnlm-container:-moz-full-screen #scene-info,
    .pnlm-container:-moz-full-screen #hotspots-menu,
    .pnlm-container:fullscreen #top-controls,
    .pnlm-container:fullscreen #scene-info,
    .pnlm-container:fullscreen #hotspots-menu {
        z-index: 9999 !important;
    }

    /* Animación para menú lateral */
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .animate-slideInLeft {
        animation: slideInLeft 0.3s ease-out;
    }

    /* Scroll personalizado para el menú */
    #hotspots-menu::-webkit-scrollbar {
        width: 6px;
    }

    #hotspots-menu::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
    }

    #hotspots-menu::-webkit-scrollbar-thumb {
        background: rgba(59, 130, 246, 0.5);
        border-radius: 10px;
    }

    #hotspots-menu::-webkit-scrollbar-thumb:hover {
        background: rgba(59, 130, 246, 0.7);
    }
    .hotspot-item {
    width: 100%;
    text-align: left;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    transition: all 0.2s;
    font-medium: true;
    color: #374151;
    margin-bottom: 0.25rem;
    display: block;
}

.hotspot-item:hover {
    background-color: #EFF6FF;
    transform: translateX(4px);
}
</style>